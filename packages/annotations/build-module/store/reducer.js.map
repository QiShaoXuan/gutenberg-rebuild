{"version":3,"sources":["@wordpress/annotations/src/store/reducer.js"],"names":["get","isNumber","mapValues","filterWithReference","collection","predicate","filteredCollection","filter","length","isValidAnnotationRange","annotation","start","end","annotations","state","action","type","blockClientId","newAnnotation","id","richTextIdentifier","source","selector","range","previousAnnotationsForBlock","annotationsForBlock","annotationId","hasChangedRange","newAnnotations","map"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { get, isNumber, mapValues } from 'lodash';\n\n/**\n * Filters an array based on the predicate, but keeps the reference the same if\n * the array hasn't changed.\n *\n * @param {Array}    collection The collection to filter.\n * @param {Function} predicate  Function that determines if the item should stay\n *                              in the array.\n * @return {Array} Filtered array.\n */\nfunction filterWithReference( collection, predicate ) {\n\tconst filteredCollection = collection.filter( predicate );\n\n\treturn collection.length === filteredCollection.length ? collection : filteredCollection;\n}\n\n/**\n * Verifies whether the given annotations is a valid annotation.\n *\n * @param {Object} annotation The annotation to verify.\n * @return {boolean} Whether the given annotation is valid.\n */\nfunction isValidAnnotationRange( annotation ) {\n\treturn isNumber( annotation.start ) &&\n\t\tisNumber( annotation.end ) &&\n\t\tannotation.start <= annotation.end;\n}\n\n/**\n * Reducer managing annotations.\n *\n * @param {Array} state The annotations currently shown in the editor.\n * @param {Object} action Dispatched action.\n *\n * @return {Array} Updated state.\n */\nexport function annotations( state = {}, action ) {\n\tswitch ( action.type ) {\n\t\tcase 'ANNOTATION_ADD':\n\t\t\tconst blockClientId = action.blockClientId;\n\t\t\tconst newAnnotation = {\n\t\t\t\tid: action.id,\n\t\t\t\tblockClientId,\n\t\t\t\trichTextIdentifier: action.richTextIdentifier,\n\t\t\t\tsource: action.source,\n\t\t\t\tselector: action.selector,\n\t\t\t\trange: action.range,\n\t\t\t};\n\n\t\t\tif ( newAnnotation.selector === 'range' && ! isValidAnnotationRange( newAnnotation.range ) ) {\n\t\t\t\treturn state;\n\t\t\t}\n\n\t\t\tconst previousAnnotationsForBlock = get( state, blockClientId, [] );\n\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\t[ blockClientId ]: [ ...previousAnnotationsForBlock, newAnnotation ],\n\t\t\t};\n\n\t\tcase 'ANNOTATION_REMOVE':\n\t\t\treturn mapValues( state, ( annotationsForBlock ) => {\n\t\t\t\treturn filterWithReference( annotationsForBlock, ( annotation ) => {\n\t\t\t\t\treturn annotation.id !== action.annotationId;\n\t\t\t\t} );\n\t\t\t} );\n\n\t\tcase 'ANNOTATION_UPDATE_RANGE':\n\t\t\treturn mapValues( state, ( annotationsForBlock ) => {\n\t\t\t\tlet hasChangedRange = false;\n\n\t\t\t\tconst newAnnotations = annotationsForBlock.map( ( annotation ) => {\n\t\t\t\t\tif ( annotation.id === action.annotationId ) {\n\t\t\t\t\t\thasChangedRange = true;\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t...annotation,\n\t\t\t\t\t\t\trange: {\n\t\t\t\t\t\t\t\tstart: action.start,\n\t\t\t\t\t\t\t\tend: action.end,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\n\t\t\t\t\treturn annotation;\n\t\t\t\t} );\n\n\t\t\t\treturn hasChangedRange ? newAnnotations : annotationsForBlock;\n\t\t\t} );\n\n\t\tcase 'ANNOTATION_REMOVE_SOURCE':\n\t\t\treturn mapValues( state, ( annotationsForBlock ) => {\n\t\t\t\treturn filterWithReference( annotationsForBlock, ( annotation ) => {\n\t\t\t\t\treturn annotation.source !== action.source;\n\t\t\t\t} );\n\t\t\t} );\n\t}\n\n\treturn state;\n}\n\nexport default annotations;\n"]}