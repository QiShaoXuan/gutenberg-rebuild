{"version":3,"sources":["@wordpress/block-library/src/legacy-widget/WidgetEditDomManager.js"],"names":["includes","Component","createRef","isShallowEqual","WidgetEditDomManager","arguments","containerRef","formRef","widgetContentRef","triggerWidgetEvent","bind","previousFormData","window","FormData","current","nextProps","form","props","widgetContent","innerHTML","id","idBase","widgetNumber","shouldTriggerInstanceUpdate","onInstanceChange","retrieveUpdatedInstance","__html","currentFormData","currentFormDataKeys","Array","from","keys","previousFormDataKeys","length","rawKey","getAll","event","$","document","trigger","formData","updatedInstance","keyPrefixLength","keySuffixLength","keyParsed","substring","value"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { includes } from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport { Component, createRef } from '@wordpress/element';\nimport isShallowEqual from '@wordpress/is-shallow-equal';\n\nclass WidgetEditDomManager extends Component {\n\tconstructor() {\n\t\tsuper( ...arguments );\n\n\t\tthis.containerRef = createRef();\n\t\tthis.formRef = createRef();\n\t\tthis.widgetContentRef = createRef();\n\t\tthis.triggerWidgetEvent = this.triggerWidgetEvent.bind( this );\n\t}\n\n\tcomponentDidMount() {\n\t\tthis.triggerWidgetEvent( 'widget-added' );\n\t\tthis.previousFormData = new window.FormData(\n\t\t\tthis.formRef.current\n\t\t);\n\t}\n\n\tshouldComponentUpdate( nextProps ) {\n\t\t// We can not leverage react render otherwise we would destroy dom changes applied by the plugins.\n\t\t// We manually update the required dom node replicating what the widget screen and the customizer do.\n\t\tif ( nextProps.form !== this.props.form && this.widgetContentRef.current ) {\n\t\t\tconst widgetContent = this.widgetContentRef.current;\n\t\t\twidgetContent.innerHTML = nextProps.form;\n\t\t\tthis.triggerWidgetEvent( 'widget-updated' );\n\t\t\tthis.previousFormData = new window.FormData(\n\t\t\t\tthis.formRef.current\n\t\t\t);\n\t\t}\n\t\treturn false;\n\t}\n\n\trender() {\n\t\tconst { id, idBase, widgetNumber, form } = this.props;\n\t\treturn (\n\t\t\t<div className=\"widget open\" ref={ this.containerRef }>\n\t\t\t\t<div className=\"widget-inside\">\n\t\t\t\t\t<form\n\t\t\t\t\t\tref={ this.formRef }\n\t\t\t\t\t\tmethod=\"post\"\n\t\t\t\t\t\tonBlur={ () => {\n\t\t\t\t\t\t\tif ( this.shouldTriggerInstanceUpdate() ) {\n\t\t\t\t\t\t\t\tthis.props.onInstanceChange(\n\t\t\t\t\t\t\t\t\tthis.retrieveUpdatedInstance()\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} }\n\t\t\t\t\t>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tref={ this.widgetContentRef }\n\t\t\t\t\t\t\tclassName=\"widget-content\"\n\t\t\t\t\t\t\tdangerouslySetInnerHTML={ { __html: form } }\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<input type=\"hidden\" name=\"widget-id\" className=\"widget-id\" value={ id } />\n\t\t\t\t\t\t<input type=\"hidden\" name=\"id_base\" className=\"id_base\" value={ idBase } />\n\t\t\t\t\t\t<input type=\"hidden\" name=\"widget_number\" className=\"widget_number\" value={ widgetNumber } />\n\t\t\t\t\t\t<input type=\"hidden\" name=\"multi_number\" className=\"multi_number\" value=\"\" />\n\t\t\t\t\t\t<input type=\"hidden\" name=\"add_new\" className=\"add_new\" value=\"\" />\n\t\t\t\t\t</form>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t);\n\t}\n\n\tshouldTriggerInstanceUpdate() {\n\t\tif ( ! this.formRef.current ) {\n\t\t\treturn false;\n\t\t}\n\t\tif ( ! this.previousFormData ) {\n\t\t\treturn true;\n\t\t}\n\t\tconst currentFormData = new window.FormData(\n\t\t\tthis.formRef.current\n\t\t);\n\t\tconst currentFormDataKeys = Array.from( currentFormData.keys() );\n\t\tconst previousFormDataKeys = Array.from( this.previousFormData.keys() );\n\t\tif (\n\t\t\tcurrentFormDataKeys.length !== previousFormDataKeys.length\n\t\t) {\n\t\t\treturn true;\n\t\t}\n\t\tfor ( const rawKey of currentFormDataKeys ) {\n\t\t\tif ( ! isShallowEqual(\n\t\t\t\tcurrentFormData.getAll( rawKey ),\n\t\t\t\tthis.previousFormData.getAll( rawKey )\n\t\t\t) ) {\n\t\t\t\tthis.previousFormData = currentFormData;\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\ttriggerWidgetEvent( event ) {\n\t\twindow.$( window.document ).trigger(\n\t\t\tevent,\n\t\t\t[ window.$( this.containerRef.current ) ]\n\t\t);\n\t}\n\n\tretrieveUpdatedInstance() {\n\t\tif ( this.formRef.current ) {\n\t\t\tconst { idBase, widgetNumber } = this.props;\n\t\t\tconst form = this.formRef.current;\n\t\t\tconst formData = new window.FormData( form );\n\t\t\tconst updatedInstance = {};\n\t\t\tconst keyPrefixLength = `widget-${ idBase }[${ widgetNumber }][`.length;\n\t\t\tconst keySuffixLength = `]`.length;\n\t\t\tfor ( const rawKey of formData.keys() ) {\n\t\t\t\t// This fields are added to the form because the widget JavaScript code may use this values.\n\t\t\t\t// They are not relevant for the update mechanism.\n\t\t\t\tif ( includes(\n\t\t\t\t\t[ 'widget-id', 'id_base', 'widget_number', 'multi_number', 'add_new' ],\n\t\t\t\t\trawKey,\n\t\t\t\t) ) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tconst keyParsed = rawKey.substring( keyPrefixLength, rawKey.length - keySuffixLength );\n\n\t\t\t\tconst value = formData.getAll( rawKey );\n\t\t\t\tif ( value.length > 1 ) {\n\t\t\t\t\tupdatedInstance[ keyParsed ] = value;\n\t\t\t\t} else {\n\t\t\t\t\tupdatedInstance[ keyParsed ] = value[ 0 ];\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn updatedInstance;\n\t\t}\n\t}\n}\n\nexport default WidgetEditDomManager;\n\n"]}