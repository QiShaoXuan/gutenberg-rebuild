{"version":3,"sources":["@wordpress/block-library/src/legacy-widget/WidgetEditHandler.js"],"names":["WidgetEditHandler","arguments","state","form","idBase","instanceUpdating","onInstanceChange","bind","requestWidgetUpdater","isStillMounted","prevProps","instance","props","instanceId","identifier","id","display","isVisible","ref","widgetEditDomManagerRef","instanceChanges","response","callback","path","data","id_to_use","instance_changes","method","then","setState","id_base","Component"],"mappings":"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","sourcesContent":["/**\n * WordPress dependencies\n */\nimport { Component } from '@wordpress/element';\nimport { __ } from '@wordpress/i18n';\nimport apiFetch from '@wordpress/api-fetch';\nimport { withInstanceId } from '@wordpress/compose';\n\n/**\n * Internal dependencies\n */\nimport WidgetEditDomManager from './WidgetEditDomManager';\n\nclass WidgetEditHandler extends Component {\n\tconstructor() {\n\t\tsuper( ...arguments );\n\t\tthis.state = {\n\t\t\tform: null,\n\t\t\tidBase: null,\n\t\t};\n\t\tthis.instanceUpdating = null;\n\t\tthis.onInstanceChange = this.onInstanceChange.bind( this );\n\t\tthis.requestWidgetUpdater = this.requestWidgetUpdater.bind( this );\n\t}\n\n\tcomponentDidMount() {\n\t\tthis.isStillMounted = true;\n\t\tthis.requestWidgetUpdater();\n\t}\n\n\tcomponentDidUpdate( prevProps ) {\n\t\tif (\n\t\t\tprevProps.instance !== this.props.instance &&\n\t\t\tthis.instanceUpdating !== this.props.instance\n\t\t) {\n\t\t\tthis.requestWidgetUpdater();\n\t\t}\n\t\tif ( this.instanceUpdating === this.props.instance ) {\n\t\t\tthis.instanceUpdating = null;\n\t\t}\n\t}\n\n\tcomponentWillUnmount() {\n\t\tthis.isStillMounted = false;\n\t}\n\n\trender() {\n\t\tconst { instanceId, identifier } = this.props;\n\t\tconst { id, idBase, form } = this.state;\n\t\tif ( ! identifier ) {\n\t\t\treturn __( 'Not a valid widget.' );\n\t\t}\n\t\tif ( ! form ) {\n\t\t\treturn null;\n\t\t}\n\t\treturn (\n\t\t\t<div\n\t\t\t\tclassName=\"wp-block-legacy-widget__edit-container\"\n\t\t\t\t// Display none is used because when we switch from edit to preview,\n\t\t\t\t// we don't want to unmount the component.\n\t\t\t\t// Otherwise when we went back to edit we wound need to trigger\n\t\t\t\t// all widgets events again and some scripts may not deal well with this.\n\t\t\t\tstyle={ {\n\t\t\t\t\tdisplay: this.props.isVisible ? 'block' : 'none',\n\t\t\t\t} }\n\t\t\t>\n\t\t\t\t<WidgetEditDomManager\n\t\t\t\t\tref={ ( ref ) => {\n\t\t\t\t\t\tthis.widgetEditDomManagerRef = ref;\n\t\t\t\t\t} }\n\t\t\t\t\tonInstanceChange={ this.onInstanceChange }\n\t\t\t\t\twidgetNumber={ instanceId * -1 }\n\t\t\t\t\tid={ id }\n\t\t\t\t\tidBase={ idBase }\n\t\t\t\t\tform={ form }\n\t\t\t\t/>\n\t\t\t</div>\n\t\t);\n\t}\n\n\tonInstanceChange( instanceChanges ) {\n\t\tthis.requestWidgetUpdater( instanceChanges, ( response ) => {\n\t\t\tthis.instanceUpdating = response.instance;\n\t\t\tthis.props.onInstanceChange( response.instance );\n\t\t} );\n\t}\n\n\trequestWidgetUpdater( instanceChanges, callback ) {\n\t\tconst { identifier, instanceId, instance } = this.props;\n\t\tif ( ! identifier ) {\n\t\t\treturn;\n\t\t}\n\n\t\tapiFetch( {\n\t\t\tpath: `/wp/v2/widgets/${ identifier }/`,\n\t\t\tdata: {\n\t\t\t\tidentifier,\n\t\t\t\tinstance,\n\t\t\t\t// use negative ids to make sure the id does not exist on the database.\n\t\t\t\tid_to_use: instanceId * -1,\n\t\t\t\tinstance_changes: instanceChanges,\n\t\t\t},\n\t\t\tmethod: 'POST',\n\t\t} ).then(\n\t\t\t( response ) => {\n\t\t\t\tif ( this.isStillMounted ) {\n\t\t\t\t\tthis.setState( {\n\t\t\t\t\t\tform: response.form,\n\t\t\t\t\t\tidBase: response.id_base,\n\t\t\t\t\t\tid: response.id,\n\t\t\t\t\t} );\n\t\t\t\t\tif ( callback ) {\n\t\t\t\t\t\tcallback( response );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t);\n\t}\n}\n\nexport default withInstanceId( WidgetEditHandler );\n\n"]}