{"version":3,"sources":["@wordpress/edit-post/src/store/effects.js"],"names":["VIEW_AS_LINK_SELECTOR","effects","SET_META_BOXES_PER_LOCATIONS","action","store","setTimeout","postType","getCurrentPostType","window","postboxes","page","add_postbox_toggles","wasSavingPost","isSavingPost","wasAutosavingPost","isAutosavingPost","wasPreviewingPost","isPreviewingPost","hasActiveMetaBoxes","hasMetaBoxes","shouldTriggerMetaboxesSave","dispatch","REQUEST_META_BOX_UPDATES","tinyMCE","triggerSave","state","getState","post","getCurrentPost","additionalData","comment_status","ping_status","sticky","author","filter","Boolean","baseFormData","FormData","document","querySelector","formDataToMerge","map","location","formData","memo","currentFormData","key","value","append","forEach","url","_wpMetaBoxUrl","method","body","parse","then","SWITCH_MODE","mode","clearSelectedBlock","message","INIT","_","getBlockSelectionStart","hasBlockSelection","isEditorSidebarOpened","isMobileViewPort","isViewportMatch","adjustSidebar","sidebarToReOpenOnExpand","isSmall","updateViewAsLink","newPermalink","nodeToUpdate","setAttribute","link"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { reduce } from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport { select, subscribe, dispatch } from '@wordpress/data';\nimport { speak } from '@wordpress/a11y';\nimport { __ } from '@wordpress/i18n';\nimport apiFetch from '@wordpress/api-fetch';\n\n/**\n * Internal dependencies\n */\nimport {\n\tmetaBoxUpdatesSuccess,\n\trequestMetaBoxUpdates,\n\topenGeneralSidebar,\n\tcloseGeneralSidebar,\n} from './actions';\nimport {\n\tgetActiveMetaBoxLocations,\n\tgetActiveGeneralSidebarName,\n} from './selectors';\nimport { getMetaBoxContainer } from '../utils/meta-boxes';\nimport { onChangeListener } from './utils';\n\nconst VIEW_AS_LINK_SELECTOR = '#wp-admin-bar-view a';\n\nconst effects = {\n\tSET_META_BOXES_PER_LOCATIONS( action, store ) {\n\t\t// Allow toggling metaboxes panels\n\t\t// We need to wait for all scripts to load\n\t\t// If the meta box loads the post script, it will already trigger this.\n\t\t// After merge in Core, make sure to drop the timeout and update the postboxes script\n\t\t// to avoid the double binding.\n\t\tsetTimeout( () => {\n\t\t\tconst postType = select( 'core/editor' ).getCurrentPostType();\n\t\t\tif ( window.postboxes.page !== postType ) {\n\t\t\t\twindow.postboxes.add_postbox_toggles( postType );\n\t\t\t}\n\t\t} );\n\n\t\tlet wasSavingPost = select( 'core/editor' ).isSavingPost();\n\t\tlet wasAutosavingPost = select( 'core/editor' ).isAutosavingPost();\n\t\tlet wasPreviewingPost = select( 'core/editor' ).isPreviewingPost();\n\t\t// Save metaboxes when performing a full save on the post.\n\t\tsubscribe( () => {\n\t\t\tconst isSavingPost = select( 'core/editor' ).isSavingPost();\n\t\t\tconst isAutosavingPost = select( 'core/editor' ).isAutosavingPost();\n\t\t\tconst isPreviewingPost = select( 'core/editor' ).isPreviewingPost();\n\t\t\tconst hasActiveMetaBoxes = select( 'core/edit-post' ).hasMetaBoxes();\n\n\t\t\t// Save metaboxes on save completion, except for autosaves that are not a post preview.\n\t\t\tconst shouldTriggerMetaboxesSave = (\n\t\t\t\thasActiveMetaBoxes && (\n\t\t\t\t\t( wasSavingPost && ! isSavingPost && ! wasAutosavingPost ) ||\n\t\t\t\t\t( wasAutosavingPost && wasPreviewingPost && ! isPreviewingPost )\n\t\t\t\t)\n\t\t\t);\n\n\t\t\t// Save current state for next inspection.\n\t\t\twasSavingPost = isSavingPost;\n\t\t\twasAutosavingPost = isAutosavingPost;\n\t\t\twasPreviewingPost = isPreviewingPost;\n\n\t\t\tif ( shouldTriggerMetaboxesSave ) {\n\t\t\t\tstore.dispatch( requestMetaBoxUpdates() );\n\t\t\t}\n\t\t} );\n\t},\n\tREQUEST_META_BOX_UPDATES( action, store ) {\n\t\t// Saves the wp_editor fields\n\t\tif ( window.tinyMCE ) {\n\t\t\twindow.tinyMCE.triggerSave();\n\t\t}\n\n\t\tconst state = store.getState();\n\n\t\t// Additional data needed for backward compatibility.\n\t\t// If we do not provide this data, the post will be overridden with the default values.\n\t\tconst post = select( 'core/editor' ).getCurrentPost( state );\n\t\tconst additionalData = [\n\t\t\tpost.comment_status ? [ 'comment_status', post.comment_status ] : false,\n\t\t\tpost.ping_status ? [ 'ping_status', post.ping_status ] : false,\n\t\t\tpost.sticky ? [ 'sticky', post.sticky ] : false,\n\t\t\t[ 'post_author', post.author ],\n\t\t].filter( Boolean );\n\n\t\t// We gather all the metaboxes locations data and the base form data\n\t\tconst baseFormData = new window.FormData( document.querySelector( '.metabox-base-form' ) );\n\t\tconst formDataToMerge = [\n\t\t\tbaseFormData,\n\t\t\t...getActiveMetaBoxLocations( state ).map( ( location ) => (\n\t\t\t\tnew window.FormData( getMetaBoxContainer( location ) )\n\t\t\t) ),\n\t\t];\n\n\t\t// Merge all form data objects into a single one.\n\t\tconst formData = reduce( formDataToMerge, ( memo, currentFormData ) => {\n\t\t\tfor ( const [ key, value ] of currentFormData ) {\n\t\t\t\tmemo.append( key, value );\n\t\t\t}\n\t\t\treturn memo;\n\t\t}, new window.FormData() );\n\t\tadditionalData.forEach( ( [ key, value ] ) => formData.append( key, value ) );\n\n\t\t// Save the metaboxes\n\t\tapiFetch( {\n\t\t\turl: window._wpMetaBoxUrl,\n\t\t\tmethod: 'POST',\n\t\t\tbody: formData,\n\t\t\tparse: false,\n\t\t} )\n\t\t\t.then( () => store.dispatch( metaBoxUpdatesSuccess() ) );\n\t},\n\tSWITCH_MODE( action ) {\n\t\t// Unselect blocks when we switch to the code editor.\n\t\tif ( action.mode !== 'visual' ) {\n\t\t\tdispatch( 'core/block-editor' ).clearSelectedBlock();\n\t\t}\n\n\t\tconst message = action.mode === 'visual' ? __( 'Visual editor selected' ) : __( 'Code editor selected' );\n\t\tspeak( message, 'assertive' );\n\t},\n\tINIT( _, store ) {\n\t\t// Select the block settings tab when the selected block changes\n\t\tsubscribe( onChangeListener(\n\t\t\t() => !! select( 'core/block-editor' ).getBlockSelectionStart(),\n\t\t\t( hasBlockSelection ) => {\n\t\t\t\tif ( ! select( 'core/edit-post' ).isEditorSidebarOpened() ) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif ( hasBlockSelection ) {\n\t\t\t\t\tstore.dispatch( openGeneralSidebar( 'edit-post/block' ) );\n\t\t\t\t} else {\n\t\t\t\t\tstore.dispatch( openGeneralSidebar( 'edit-post/document' ) );\n\t\t\t\t}\n\t\t\t} )\n\t\t);\n\n\t\tconst isMobileViewPort = () => select( 'core/viewport' ).isViewportMatch( '< medium' );\n\t\tconst adjustSidebar = ( () => {\n\t\t\t// contains the sidebar we close when going to viewport sizes lower than medium.\n\t\t\t// This allows to reopen it when going again to viewport sizes greater than medium.\n\t\t\tlet sidebarToReOpenOnExpand = null;\n\t\t\treturn ( isSmall ) => {\n\t\t\t\tif ( isSmall ) {\n\t\t\t\t\tsidebarToReOpenOnExpand = getActiveGeneralSidebarName( store.getState() );\n\t\t\t\t\tif ( sidebarToReOpenOnExpand ) {\n\t\t\t\t\t\tstore.dispatch( closeGeneralSidebar() );\n\t\t\t\t\t}\n\t\t\t\t} else if ( sidebarToReOpenOnExpand && ! getActiveGeneralSidebarName( store.getState() ) ) {\n\t\t\t\t\tstore.dispatch( openGeneralSidebar( sidebarToReOpenOnExpand ) );\n\t\t\t\t}\n\t\t\t};\n\t\t} )();\n\n\t\tadjustSidebar( isMobileViewPort() );\n\n\t\t// Collapse sidebar when viewport shrinks.\n\t\t// Reopen sidebar it if viewport expands and it was closed because of a previous shrink.\n\t\tsubscribe( onChangeListener( isMobileViewPort, adjustSidebar ) );\n\n\t\t// Update View as link when currentPost link changes\n\t\tconst updateViewAsLink = ( newPermalink ) => {\n\t\t\tif ( ! newPermalink ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst nodeToUpdate = document.querySelector(\n\t\t\t\tVIEW_AS_LINK_SELECTOR\n\t\t\t);\n\t\t\tif ( ! nodeToUpdate ) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tnodeToUpdate.setAttribute( 'href', newPermalink );\n\t\t};\n\n\t\tsubscribe( onChangeListener(\n\t\t\t() => select( 'core/editor' ).getCurrentPost().link,\n\t\t\tupdateViewAsLink\n\t\t) );\n\t},\n\n};\n\nexport default effects;\n"]}