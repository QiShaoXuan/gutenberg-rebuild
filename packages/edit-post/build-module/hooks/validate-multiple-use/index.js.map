{"version":3,"sources":["@wordpress/edit-post/src/hooks/validate-multiple-use/index.js"],"names":["find","createBlock","findTransform","getBlockTransforms","getBlockType","hasBlockSupport","Button","withSelect","withDispatch","Warning","addFilter","__","compose","createHigherOrderComponent","enhance","select","block","multiple","name","blocks","getBlocks","firstOfSameType","isInvalid","clientId","originalBlockClientId","dispatch","selectFirst","selectBlock","withMultipleValidation","BlockEdit","props","blockType","outboundType","getOutboundType","minHeight","onReplace","attributes","title","blockName","transform","type","length"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { find } from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport {\n\tcreateBlock,\n\tfindTransform,\n\tgetBlockTransforms,\n\tgetBlockType,\n\thasBlockSupport,\n} from '@wordpress/blocks';\nimport { Button } from '@wordpress/components';\nimport { withSelect, withDispatch } from '@wordpress/data';\nimport { Warning } from '@wordpress/block-editor';\nimport { addFilter } from '@wordpress/hooks';\nimport { __ } from '@wordpress/i18n';\nimport { compose, createHigherOrderComponent } from '@wordpress/compose';\n\nconst enhance = compose(\n\t/**\n\t * For blocks whose block type doesn't support `multiple`, provides the\n\t * wrapped component with `originalBlockClientId` -- a reference to the\n\t * first block of the same type in the content -- if and only if that\n\t * \"original\" block is not the current one. Thus, an inexisting\n\t * `originalBlockClientId` prop signals that the block is valid.\n\t *\n\t * @param {Component} WrappedBlockEdit A filtered BlockEdit instance.\n\t *\n\t * @return {Component} Enhanced component with merged state data props.\n\t */\n\twithSelect( ( select, block ) => {\n\t\tconst multiple = hasBlockSupport( block.name, 'multiple', true );\n\n\t\t// For block types with `multiple` support, there is no \"original\n\t\t// block\" to be found in the content, as the block itself is valid.\n\t\tif ( multiple ) {\n\t\t\treturn {};\n\t\t}\n\n\t\t// Otherwise, only pass `originalBlockClientId` if it refers to a different\n\t\t// block from the current one.\n\t\tconst blocks = select( 'core/block-editor' ).getBlocks();\n\t\tconst firstOfSameType = find( blocks, ( { name } ) => block.name === name );\n\t\tconst isInvalid = firstOfSameType && firstOfSameType.clientId !== block.clientId;\n\t\treturn {\n\t\t\toriginalBlockClientId: isInvalid && firstOfSameType.clientId,\n\t\t};\n\t} ),\n\twithDispatch( ( dispatch, { originalBlockClientId } ) => ( {\n\t\tselectFirst: () => dispatch( 'core/block-editor' ).selectBlock( originalBlockClientId ),\n\t} ) ),\n);\n\nconst withMultipleValidation = createHigherOrderComponent( ( BlockEdit ) => {\n\treturn enhance( ( {\n\t\toriginalBlockClientId,\n\t\tselectFirst,\n\t\t...props\n\t} ) => {\n\t\tif ( ! originalBlockClientId ) {\n\t\t\treturn <BlockEdit { ...props } />;\n\t\t}\n\n\t\tconst blockType = getBlockType( props.name );\n\t\tconst outboundType = getOutboundType( props.name );\n\n\t\treturn [\n\t\t\t<div key=\"invalid-preview\" style={ { minHeight: '60px' } }>\n\t\t\t\t<BlockEdit key=\"block-edit\" { ...props } />\n\t\t\t</div>,\n\t\t\t<Warning\n\t\t\t\tkey=\"multiple-use-warning\"\n\t\t\t\tactions={ [\n\t\t\t\t\t<Button key=\"find-original\" isLarge onClick={ selectFirst }>\n\t\t\t\t\t\t{ __( 'Find original' ) }\n\t\t\t\t\t</Button>,\n\t\t\t\t\t<Button key=\"remove\" isLarge onClick={ () => props.onReplace( [] ) }>\n\t\t\t\t\t\t{ __( 'Remove' ) }\n\t\t\t\t\t</Button>,\n\t\t\t\t\toutboundType && (\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tkey=\"transform\"\n\t\t\t\t\t\t\tisLarge\n\t\t\t\t\t\t\tonClick={ () => props.onReplace(\n\t\t\t\t\t\t\t\tcreateBlock( outboundType.name, props.attributes )\n\t\t\t\t\t\t\t) }\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{ __( 'Transform into:' ) }{ ' ' }\n\t\t\t\t\t\t\t{ outboundType.title }\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t),\n\t\t\t\t] }\n\t\t\t>\n\t\t\t\t<strong>{ blockType.title }: </strong>\n\t\t\t\t{ __( 'This block can only be used once.' ) }\n\t\t\t</Warning>,\n\t\t];\n\t} );\n}, 'withMultipleValidation' );\n\n/**\n * Given a base block name, returns the default block type to which to offer\n * transforms.\n *\n * @param {string} blockName Base block name.\n *\n * @return {?Object} The chosen default block type.\n */\nfunction getOutboundType( blockName ) {\n\t// Grab the first outbound transform\n\tconst transform = findTransform(\n\t\tgetBlockTransforms( 'to', blockName ),\n\t\t( { type, blocks } ) => type === 'block' && blocks.length === 1 // What about when .length > 1?\n\t);\n\n\tif ( ! transform ) {\n\t\treturn null;\n\t}\n\n\treturn getBlockType( transform.blocks[ 0 ] );\n}\n\naddFilter(\n\t'editor.BlockEdit',\n\t'core/edit-post/validate-multiple-use/with-multiple-validation',\n\twithMultipleValidation\n);\n"]}